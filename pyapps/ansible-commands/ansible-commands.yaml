# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  ANSIBLE_HOME: "${HOME}/.ansible"

tasks:
  init:
    internal: true
    silent: true
    desc: "Initialize Ansible Command"
    sources:
      - pyproject.toml
      - "{{.ANSIBLE_HOME}}/collections/requirements.yml"
      - "{{.ANSIBLE_HOME}}/roles/requirements.yml"
    generates:
      - poetry.lock
    cmds:
      - poetry install
      - ansible-galaxy collection install -r {{.ANSIBLE_HOME}}/collections/requirements.yml
      - ansible-galaxy role install -r {{.ANSIBLE_HOME}}/roles/requirements.yml

  build:
    internal: true
    silent: true
    deps:
      - init
    desc: "Build Ansible Commands"
    cmds:
      - nx build ansible-commands
    sources:
      - ansible-command/ansible_commands/**/*.py

  update:
    internal: true
    silent: true
    desc: "Update Ansible Command Dependencies"
    cmds:
      - nx update ansible-commands

  install:
    internal: true
    silent: true
    deps:
      - build
    desc: "Install Ansible Commands"
    cmds:
      - nx install ansible-commands
      - pipx install . --force --include-deps
    sources:
      - trapper-keeper/trapper_keeper/**/*.py
    generates:
      - "{{.XDG_BIN_HOME}}/ansible-commands"

  run:
    desc: "Run Ansible Command"
    summary: |

    deps:
      - install
    cmds:
      - ansible-commands {{.CLI_ARGS}}
    dir: "{{.ANSIBLE_HOME}}"
